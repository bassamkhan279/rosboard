<!doctype html>
<html>
<head>
Â  <meta charset="utf-8">
Â  <title>Autonomous Oil Palm Harvesting Robot System Camera</title>
Â  
Â  <link rel="stylesheet" href="css/material.blue_grey-indigo.min.css">
Â  <link href="css/material-icons.css" rel="stylesheet"> 
Â  <link rel="stylesheet" href="css/rosboard.css">
Â  <link rel="stylesheet" href="css/uPlot.min.css">
Â  <link rel="stylesheet" href="css/leaflet.css">
Â  <link href="css/index.css" media="all" rel="stylesheet" type="text/css">

Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">

Â  <style>
Â  Â  /* === STYLING (Unmodified) === */
Â  Â  .mdl-layout__drawer .mdl-navigation__link {
Â  Â  Â  Â  color: white; /* <-- CSS FIX: Added semicolon */
Â  Â  }
Â  Â  /* ... (rest of CSS styles) ... */
Â  Â  .sidebar-user-info {
Â  Â  Â  position: absolute; bottom: 0; width: 100%; border-top: 1px solid rgba(255,255,255,0.1); padding: 16px; box-sizing: border-box; 
 }
Â  Â  .sidebar-user-info .email {
Â  Â  Â  font-size: 0.9em; opacity: 0.7; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-left: 16px; padding-bottom: 8px;
Â  Â  }
Â  Â  .ros-widget-card { background-color: #424242; }
Â  Â  .ros-widget-card .mdl-card__title-text { color: #ffffff; }
Â  Â  .ros-widget-content div, .ros-widget-content span { color: #ffffff; }
Â  Â  .battery-widget-content { padding: 16px; display: flex; align-items: center; justify-content: center; gap: 20px; }
Â  Â  .battery-icon { width: 100px; height: 50px; border: 4px solid #fff; border-radius: 8px; position: relative; }
Â  Â  .battery-icon::after { content: ''; position: absolute; right: -12px; top: 12px; width: 8px; height: 22px; background: #fff; border-radius: 0 4px 4px 0; }
Â  Â  .battery-fill { height: 100%; width: 100%; background-color: #4caf50; border-radius: 2px; transition: width 0.5s ease, background-color 0.5s ease; }
Â  Â  .battery-text { font-size: 2.5em; font-weight: 300; color: #fff; }
Â  </style>
Â  
Â  <script type="text/javascript" src="js/eventemitter2.min.js"></script>
Â  <script type="text/javascript" src="js/transports/WebSocketV1Transport.js"></script>

</head>

<body>
<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
Â  <header class="mdl-layout__header">
Â  Â  <div class="mdl-layout__header-row">
Â  Â  Â  <div class="mdl-layout__drawer-button">
Â  Â  Â  Â  <i class="material-icons">menu</i>
Â  Â  Â  </div>
Â  Â  Â  <span class="mdl-layout-title">Robot Camera Feed</span>
Â  Â  Â  <div class="mdl-layout-spacer"></div>
Â  Â  Â  <div id="connection-status" class="connection-status-widget">
Â  Â  Â  Â  <i class="material-icons" style="color: red;">power_off</i>
Â  Â  Â  </div>
Â  Â  </div>
Â  </header>
Â  
Â  <div class="mdl-layout__drawer">
Â  Â  <nav id="topics-nav" class="mdl-navigation">
Â  Â  Â  Â  
Â  Â  Â  Â  <div id="topics-nav-system-title" class="topics-nav-title">System</div>
Â  Â  Â  Â  <div id="topics-nav-system"></div>

Â  Â  Â  Â  <div id="topics-nav-ros-title" class="topics-nav-title">ROBOT 2</div>
Â  Â  Â  Â  
Â  Â  Â  Â  <a class="mdl-navigation__link" href="/index.html" style="display: flex; align-items: center;">
Â  Â  Â  Â  Â  Â  <i class="material-icons" style="padding-right: 16px;">home</i>
Â  Â  Â  Â  Â  Â  Dashboard
Â  Â  Â  Â  </a>

Â  Â  Â  Â  <a class="mdl-navigation__link" href="/camera.html" style="display: flex; align-items: center;">
Â  Â  Â  Â  Â  <i class="material-icons" style="padding-right: 16px;">videocam</i>
Â  Â  Â  Â  Â  Camera
Â  Â  Â  Â  </a>
Â  Â  Â  Â  
Â  Â  Â  Â  <a class="mdl-navigation__link" href="/odom.html" style="display: flex; align-items: center;">
Â  Â  Â  Â  Â  <i class="material-icons" style="padding-right: 16px;">explore</i>
Â  Â  Â  Â  Â  Scanner
Â  Â  Â  Â  </a>
Â  Â  Â  Â  
Â  Â  Â  Â  <div style="opacity:0.3;" id="topics-nav-unsupported"></div>

Â  Â  Â  Â  <div class="sidebar-user-info" id="user-links">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  </nav>
Â  </div>
Â  
Â  <main class="mdl-layout__content">
Â  Â  <div class="mdl-grid" id="main-grid">
Â  Â  Â  
Â  Â  Â  <div class="ros-widget-card mdl-card mdl-cell mdl-cell--12-col mdl-shadow--2dp">
Â  Â  Â  Â  Â  <div class="mdl-card__title">
Â  Â  Â  Â  Â  Â  Â  <h5 class="mdl-card__title-text">/camera/rgb/image_color/compressed</h5>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  <div class="ros-widget" 
                data-widget="camera" 
                data-topic="/camera/rgb/image_color/compressed"
                data-topic-type="sensor_msgs/Image">
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <div class="ros-widget-content">
Â  Â  Â  Â  Â  Â  Â  Â  <img id="camera-image" style="width: 100%; height: auto;" src="" alt="ROS Camera Feed" />
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  
Â  Â  Â  <div class="ros-widget-card mdl-card mdl-cell mdl-cell--6-col mdl-shadow--2dp">
Â  Â  Â  Â  Â  <div class="mdl-card__title">
Â  Â  Â  Â  Â  Â  Â  <h5 class="mdl-card__title-text">Battery Status</h5>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="battery-widget-content">
Â  Â  Â  Â  Â  Â  Â  <div class="battery-icon">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="battery-fill" class="battery-fill"></div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div id="battery-text" class="battery-text">--%</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  </div>
Â  </main>
</div>

<script type="text/javascript" src="js/jquery-3.1.0.min.js"></script>
<script type="text/javascript" src="js/material.min.js" defer></script>
<script type="text/javascript" src="js/json5.min.js"></script>
<script type="text/javascript" src="js/uPlot.iife.min.js"></script>
<script type="text/javascript" src="js/jquery.transit.min.js"></script>
<script type="text/javascript" src="js/masonry.pkgd.min.js"></script>
<script type="text/javascript" src="js/import-helper.js"></script>
<script type="text/javascript" src="js/leaflet.js"></script>
<script type="text/javascript" src="js/gl-matrix.js"></script>
<script type="text/javascript" src="js/litegl.min.js"></script>

<script>
// --- Session Loading and Sidebar Rendering (Secured) ---
document.addEventListener("DOMContentLoaded", () => {
Â  const userLinksContainer = document.getElementById("user-links");
Â  
Â  fetch('/api/get_session')
Â  Â  .then(response => {
Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  window.location.href = '/login'; 
Â  Â  Â  Â  throw new Error('Not authenticated');
Â  Â  Â  }
Â  Â  Â  return response.json();
Â  Â  })
Â  Â  .then(user => {
Â  Â  Â  let linksHtml = '';
Â  Â  Â  
Â  Â  Â  if (user.role === 'admin') {
Â  Â  Â  Â  linksHtml += `<a class="mdl-navigation__link" href="/admin" style="display: flex; align-items: center;">
Â  Â  Â  Â  Â  <i class="material-icons" style="padding-right: 16px;">admin_panel_settings</i>Admin Panel
Â  Â  Â  Â  </a>`;
Â  Â  Â  }
Â  Â  Â  linksHtml += `<a class="mdl-navigation__link" href="/profile" style="display: flex; align-items: center;">
Â  Â  Â  Â  Â  <i class="material-icons" style="padding-right: 16px;">person</i>Profile
Â  Â  Â  Â  </a>`;
Â  Â  Â  linksHtml += `<div class="email" title="${user.email}">${user.email}</div>
Â  Â  Â  Â  <a class="mdl-navigation__link" href="/logout" style="display: flex; align-items: center;">
Â  Â  Â  Â  Â  <i class="material-icons" style="padding-right: 16px;">logout</i>Logout
Â  Â  Â  Â  </a>`;
Â  Â  Â  userLinksContainer.innerHTML = linksHtml;
Â  Â  Â  
Â  Â  Â  if (typeof componentHandler !== 'undefined') {
Â  Â  Â  Â  componentHandler.upgradeElements(userLinksContainer);
Â  Â  Â  }
Â  Â  })
Â  Â  .catch(error => {
Â  Â  Â  Â  if (error.message !== 'Not authenticated') {
Â  Â  Â  Â  Â  Â  console.error("Error fetching session:", error);
Â  Â  Â  Â  }
Â  Â  });
});
</script>

<script>
Â  // --- ROS Data Connection and Handlers ---
Â  let transport; 
Â  let transportOptions; 

Â  function onOpen() {
Â  Â  console.log("âœ… Connected to ROSBoard backend!");
Â  Â  document.querySelector("#connection-status i").style.color = "lime";
Â  Â  document.querySelector("#connection-status i").textContent = "power";
Â  Â  
Â  Â  transport.subscribe({
      topicName: "/camera/rgb/image_color/compressed"
    });
    console.log("ğŸ“· Subscribed to camera topic");

    transport.subscribe({
      topicName: "/battery_percentage"
    });
    console.log("ğŸ”‹ Subscribed to battery topic: /battery_percentage");
Â  }

Â  function onClose() {
Â  Â  console.warn("âš ï¸ Disconnected from ROSBoard backend");
Â  Â  document.querySelector("#connection-status i").style.color = "red";
Â  Â  document.querySelector("#connection-status i").textContent = "power_off";
Â  Â  
Â  Â  setTimeout(() => {
Â  Â  Â  Â  transport = new WebSocketV1Transport(transportOptions);
Â  Â  Â  Â  transport.connect();
Â  Â  }, 3000);
Â  }

Â  function onError(error) {
Â  Â  Â console.error("âŒ WebSocket Error:", error);
Â  }

Â  function onMsg(msg) {
Â  Â  const topicName = msg._topic_name;

Â  Â  if (topicName === "/camera/rgb/image_color/compressed") {
Â  Â  Â  if (msg.data) {
Â  Â  Â  Â  document.getElementById("camera-image").src = `data:image/jpeg;base64,${msg.data}`;
Â  Â  Â  } else {
Â  Â  Â  Â  console.error("âŒ Camera data not found in message:", msg);
Â  Â  Â  }
Â  Â  }

Â  Â  if (topicName === "/battery_percentage") {
        // ğŸŒŸ FIX: The node publishes a Float32, which comes as a simple 'data' field in ROSBoard
        if (msg.data !== undefined) {
            const percent = Math.round(msg.data); // The Float32 percentage value
            const batteryFill = document.getElementById("battery-fill");
            const batteryText = document.getElementById("battery-text");

            batteryFill.style.width = `${percent}%`;

            let color = "#4caf50";
            if (percent < 50) color = "#ffeb3b";
            if (percent < 20) color = "#f44336";
            batteryFill.style.backgroundColor = color;

            batteryText.textContent = `${percent}%`;
        }
    }
Â  }

Â  function onTopics(topics) {}
Â  function onSystem(system) {}

Â  function startRosboard() {
Â  Â  console.log("ROSBoard script starting...");
Â  Â  
Â  Â  // Corrected WebSocket path to route through the login_server.py proxy
Â  Â  const backendPath = "/rosboard/v1"; 
Â  Â  
Â  Â  console.log(`[Rosboard] Connecting to ${backendPath}`);

Â  Â  transportOptions = {
Â  Â  Â  path: backendPath,
Â  Â  Â  onOpen: onOpen,
Â  Â  Â  onMsg: onMsg,
Â  Â  Â  onClose: onClose,
Â  Â  Â  onError: onError,
Â  Â  Â  onTopics: onTopics,
Â  Â  Â  onSystem: onSystem
Â  Â  };
Â  Â  
Â  Â  transport = new WebSocketV1Transport(transportOptions);
Â  Â  transport.connect();
Â  }

Â  window.addEventListener("load", startRosboard);
</script>

</body>
</html>
